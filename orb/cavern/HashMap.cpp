#include "Cavern.h"
#include <string.h>
#include <assert.h>
#include <immintrin.h>

using orb::cavern::HashMap;

#define BUCKET_UNUSED           0
#define BUCKET_TOMB             _UINT64_MAX
#define KEY_SK_STRING_MAX_LEN   15
#define HASHMAP_FACTOR          0.8

#pragma pack(push, 8)

struct StringData
{
    uint    len;
    //uchar data[len + 1]
};

struct BinaryData
{
    uint    len;
    //uint8 data[len]
};

struct HashMap::Bucket
{
    union
    {
        struct
        {
            uint8   key_type;
            uint8   value_type;
            uint16  key_len;
            uint32  __unused;
        };
        uint64      tag;
    };

    union
    {
        struct
        {
            int64   key_iv2;
            int64   key_iv1;
        };
        char    key_ss[16];
        uchar   *key_s;
    };

    union
    {
        int64       iv;
        double      fv;
        StringData  *s;
        BinaryData  *d;
    };
}__attribute__((aligned (32)));

#pragma pack(pop)

static uint64 primes_1[] = { 37,67,97,131,163,193,227,257,293,331,353,389,419,449,487,521,547,577,613,641,673,709,739,769,809,839,877,907,929,967,997,1031,1061,1091,1123,1153,1187,1217,1249,1283,1319,1361,1381,1409,1447,1481,1511,1543,1571,1601,1637,1667,1697,1733,1777,1801,1831,1861,1889,1931,1973,1987,2017,2053,2081,2113,2153,2179,2213,2243,2273,2309,2339,2371,2411,2437,2467,2503,2531,2579,2593,2633,2657,2689,2729,2753,2789,2819,2851,2887,2917,2953,2999,3011,3041,3079,3109,3137,3169,3203,3251,3271,3299,3329,3361,3407,3433,3457,3491,3527,3557,3593,3617,3659,3691,3719,3761,3779,3821,3847,3877,3907,3943,3989,4001,4049,4073,4099,4129,4177,4201,4229,4259,4289,4327,4357,4391,4421,4451,4481,4513,4547,4583,4621,4643,4673,4721,4751,4783,4801,4861,4871,4903,4931,4967,4993,5039,5059,5099,5147,5153,5189,5227,5261,5281,5323,5347,5381,5413,5441,5477,5507,5557,5569,5623,5639,5669,5701,5737,5779,5801,5827,5857,5897,5923,5953,5987,6029,6053,6089,6113,6151,6197,6211,6247,6277,6311,6337,6373,6421,6449,6469,6521,6529,6563,6599,6637,6659,6689,6733,6761,6791,6823,6857,6883,6917,6947,6977,7013,7043,7079,7109,7151,7177,7207,7237,7283,7297,7331,7369,7393,7433,7457,7489,7523,7559,7589,7621,7649,7681,7717,7753,7789,7817,7841,7873,7907,7937,7993,8009,8039,8069,8101,8147,8161,8209,8231,8263,8291,8329,8353,8387,8419,8461,8501,8513,8563,8581,8609,8641,8677,8707,8737,8779,8803,8837,8867,8923,8929,8963,8999,9029,9059,9091,9127,9157,9187,9221,9257,9281,9319,9349,9377,9413,9461,9473,9511,9539,9587,9601,9643,9677,9697,9733,9767,9803,9829,9857,9901,9923,9967,10007,10037,10061,10091,10133,10151,10177,10211,10243,10273,10313,10337,10369,10427,10433,10477,10499,10529,10567,10597,10627,10657,10691,10723,10753,10789,10831,10853,10883,10937,10949,10979,11027,11047,11083,11113,11149,11171,11213,11239,11273,11299,11329,11369,11393,11437,11467,11489,11527,11579,11587,11617,11657,11681,11717,11777,11777,11813,11863,11887,11909,11939,11969,12007,12037,12071,12097,12143,12161,12197,12227,12263,12289,12323,12373,12391,12421,12451,12487,12517,12547,12577,12611,12641,12689,12713,12739,12781,12809,12841,12889,12899,12941,12967,13001,13033,13063,13093,13121,13159,13187,13217,13249,13291,13313,13367,13381,13411,13441,13477,13513,13537,13577,13613,13633,13669,13697,13729,13763,13799,13829,13859,13901,13921,13963,13997,14029,14051,14081,14143,14149,14177,14221,14243,14281,14321,14341,14369,14401,14437,14479,14503,14533,14561,14593,14627,14657,14699,14723,14753,14797,14821,14851,14887,14923,14947,14983,15013,15053,15073,15107,15137,15173,15217,15233,15269,15299,15329,15361,15401,15427,15461,15493,15527,15559,15601,15619,15649,15683,15727,15749,15787,15809,15859,15877,15907,15937,15971,16001,16033,16067,16097,16139,16183,16193,16229,16267,16301,16333,16361,16411,16417,16451,16481,16519,16547,16603,16619,16649,16673,16729,16741,16787,16811,16843,16871,16901,16931,16963,16993,17021,17053,17077,17117,17137,17183,17209,17239,17257,17299,17341,17359,17401,17431,17471,17497,17519,17551,17599,17627,17659,17683,17713,17749,17791,17807,17851,17881,17911,17939,17981,18013,18047,18077,18097,18143,18169,18199,18233,18269,18301,18329,18367,18397,18427,18461,18493,18523,18553,18587,18617,18637,18679,18719,18749,18773,18803,18839,18869,18911,18919,18973,19001,19037,19069,19087,19121,19163,19183,19231,19259,19289,19319,19333,19391,19423,19447,19483,19507,19543,19583,19609,19609,19661,19709,19739,19763,19801,19819,19867,19891,19927,19963,19997,20029,20063,20089,20123,20149,20183,20219,20249,20287,20297,20347,20369,20411,20443,20479,20509,20543,20563,20599,20639,20663,20693,20731,20759,20789,20809,20857,20887,20921,20959,20983,21023,21031,21067,21107,21149,21179,21211,21247,21277,21283,21341,21347,21407,21433,21467,21503,21529,21563,21599,21617,21661,21683,21727,21757,21787,21821,21851,21881,21911,21943,21977,22013,22039,22079,22111,22133,22171,22193,22229,22271,22303,22307,22367,22397,22409,22453,22483,22511,22549,22573,22621,22651,22679,22717,22751,22783,22811,22817,22877,22907,22943,22973,23003,23039,23071,23099,23131,23167,23197,23227,23251,23293,23327,23357,23371,23417,23447,23473,23509,23549,23581,23609,23633,23677,23689,23743,23773,23801,23833,23869,23899,23929,23957,23993,24029,24061,24091,24121,24151,24181,24223,24251,24281,24317,24337,24379,24413,24443,24473,24509,24533,24571,24593,24631,24671,24697,24733,24767,24799,24821,24859,24889,24923,24953,24989,25013,25037,25087,25117,25147,25183,25189,25247,25261,25309,25343,25373,25391,25439,25471,25471,25523,25561,25589,25621,25657,25693,25717,25759,25771,25819,25849,25873,25919,25951,25981,26003,26041,26053,26111,26141,26171,26203,26237,26267,26297,26321,26357,26399,26431,26459,26489,26513,26557,26591,26597,26647,26687,26717,26737,26783,26813,26839,26879,26903,26927,26959,26993,27031,27067,27103,27127,27143,27197,27211,27259,27283,27299,27337,27367,27409,27449,27487,27509,27551,27583,27611,27647,27673,27701,27743,27773,27803,27827,27851,27901,27919,27967,27997,28031,28057,28087,28123,28151,28183,28219,28229,28283,28319,28351,28351,28411,28447,28477,28499,28541,28573,28607,28631,28669,28703,28729,28759,28793,28817,28859,28879,28927,28949,28979,29023,29033,29077,29101,29147,29179,29209,29243,29269,29311,29339,29363,29401,29437,29453,29501,29531,29567,29599,29629,29663,29683,29723,29759,29789,29819,29851,29881,29917,29947,29983,30013,30047,30071,30109,30139,30169,30203,30223,30271,30293,30323,30367,30391,30431,30449,30493,30517,30559,30577,30593,30649,30677,30713,30727,30781,30809,30841,30871,30911,30941,30971,30983,31039,31069,31091,31123,31159,31193,31231,31259,31277,31327,31357,31391,31397,31397,31481,31517,31547,31583,31607,31643,31667,31699,31741,31771,31799,31817,31859,31891,31907,31963,31991,32029,32063,32089,32119,32159,32191,32213,32251,32261,32309,32341,32381,32413,32443,32479,32507,32537,32573,32603,32633,32653,32693,32719,32749,65521,98299,131071,163819,196597,229373,262139,294911,327673,360439,393209,425977,458747,491503,524287,557041,589811,622577,655357,688111,720887,753659,786431,819187,851957,884717,917503,950269,982981,1015769,1048573,1081337,1114111,1146877,1179641,1212401,1245169,1277911,1310719,1343479,1376237,1409017,1441771,1474559,1507321,1540087,1572853,1605631,1638353,1671161,1703903,1736701,1769441,1802239,1835003,1867771,1900543,1933301,1966079,1998839,2031611,2064379,2097143,2129903,2162681,2195443,2228221,2260967,2293757,2326517,2359267,2392057,2424827,2457569,2490337,2523133,2555897,2588671,2621431,2654161,2686973,2719741,2752499,2785273,2818043,2850811,2883577,2916343,2949119,2981887,3014653,3047423,3080167,3112943,3145721,3178489,3211213,3244013,3276799,3309563,3342331,3375083,3407857,3440627,3473399,3506171,3538933,3571699,3604451,3637223,3670013,3702757,3735547,3768311,3801073,3833833,3866623,3899383,3932153,3964913,3997673,4030463,4063217,4095991,4128767,4161527,4194301,4227061,4259837,4292597,4325359,4358143,4390909,4423673,4456433,4489193,4521977,4554751,4587503,4620283,4653041,4685809,4718579,4751359,4784107,4816883,4849651,4882429,4915171,4947959,4980727,5013479,5046259,5079037,5111791,5144569,5177339,5210099,5242877,5275639,5308379,5341177,5373931,5406719,5439479,5472239,5505023,5537789,5570533,5603291,5636077,5668829,5701627,5734357,5767129,5799931,5832679,5865467,5898209,5930963,5963773,5996539,6029299,6062053,6094807,6127609,6160381,6193133,6225917,6258677,6291449,6324223,6356983,6389749,6422519,6455263,6488023,6520831,6553577,6586357,6619111,6651857,6684659,6717433,6750203,6782969,6815741,6848509,6881269,6914021,6946813,6979579,7012337,7045111,7077883,7110647,7143421,7176181,7208951,7241723,7274489,7307239,7340009,7372753,7405547,7438331,7471099,7503869,7536637,7569389,7602151,7634933,7667711,7700479,7733233,7766009,7798783,7831517,7864301,7897063,7929833,7962607,7995391,8028151,8060891,8093689,8126453,8159219,8191991,8224763,8257531,8290297,8323069,8355827,8388593,8421251,8454143,8486903,8519647,8552443,8585209,8617949,8650727,8683517,8716283,8749049,8781797,8814577,8847359,8880107,8912887,8945663,8978381,9011183,9043967,9076733,9109483,9142229,9175037,9207787,9240523,9273323,9306097,9338863,9371629,9404399,9437179,9469939,9502697,9535469,9568219,9601013,9633787,9666551,9699323,9732091,9764863,9797603,9830393,9863149,9895889,9928693,9961463,9994223,10026979,10059761,10092539,10125307,10158079,10190827,10223593,10256369,10289141,10321919,10354667,10387427,10420217,10452973,10485751,10518527,10551263,10584061,10616831,10649593,10682339,10715129,10747903,10780661,10813423,10846193,10878961,10911731,10944511,10977259,11010037,11042813,11075573,11108347,11141113,11173873,11206649,11239421,11272181,11304959,11337727,11370449,11403247,11436023,11468797,11501557,11534329,11567099,11599867,11632637,11665403,11698171,11730931,11763707,11796469,11829227,11862013,11894767,11927551,11960309,11993083,12025823,12058621,12091381,12124157,12156899,12189677,12222461,12255227,12287999,12320753,12353533,12386299,12419063,12451807,12484603,12517339,12550123,12582893,12615653,12648439,12681209,12713959,12746737,12779483,12812243,12845033,12877807,12910591,12943327,12976121,13008883,13041661,13074427,13107197,13139947,13172729,13205477,13238263,13271039,13303799,13336571,13369333,13402099,13434853,13467647,13500373,13533161,13565897,13598719,13631477,13664251,13697023,13729783,13762549,13795307,13828093,13860859,13893613,13926391,13959163,13991933,14024671,14057467,14090239,14123003,14155763,14188529,14221309,14254073,14286809,14319601,14352367,14385139,14417881,14450669,14483437,14516219,14548979,14581757,14614507,14647273,14680063,14712811,14745559,14778367,14811133,14843903,14876657,14909429,14942197,14974931,15007723,15040489,15073277,15106043,15138793,15171539,15204349,15237113,15269869,15302647,15335407,15368189,15400951,15433727,15466463,15499219,15531977,15564799,15597559,15630313,15663083,15695857,15728611,15761407,15794171,15826933,15859687,15892453,15925241,15958013,15990781,16023547,16056317,16089077,16121849,16154609,16187359,16220143,16252919,16285669,16318459,16351217,16383977,16416761,16449529,16482281,16515067,16547837,16580587,16613347,16646099,16678901,16711661,16744447,16777213,16809979,16842751,16875503,16908263,16941053,16973767,17006537,17039339,17072123,17104891,17137663,17170429,17203129,17235961,17268707,17301463,17334223,17367029,17399807,17432561,17465339,17498111,17530879,17563633,17596409,17629123,17661947,17694709,17727473,17760251,17793023,17825791,17858549,17891299,17924083,17956849,17989627,18022399,18055159,18087899,18120689,18153431,18186199,18219001,18251773,18284533,18317309,18350063,18382843,18415597,18448361,18481097,18513917,18546617,18579443,18612211,18644987,18677723,18710521,18743281,18776033,18808831,18841549,18874367,18907129,18939901,18972661,19005433,19038199,19070971,19103713,19136503,19169273,19202041,19234811,19267561,19300343,19333103,19365887,19398647,19431413,19464173,19496959,19529717,19562483,19595249,19628029,19660799,19693561,19726331,19759097,19791869,19824631,19857371,19890161,19922923,19955711,19988477,20021233,20054011,20086771,20119543,20152313,20185051,20217839,20250577,20283391,20316151,20348921,20381689,20414441,20447191,20479999,20512747,20545531,20578297,20611057,20643809,20676589,20709347,20742109,20774909,20807629,20840429,20873207,20905979,20938751,20971507,21004273,21037021,21069791,21102583,21135349,21168113,21200867,21233651,21266411,21299167,21331963,21364727,21397501,21430259,21463031,21495797,21528553,21561341,21594107,21626819,21659641,21692387,21725183,21757951,21790711,21823453,21856253,21889019,21921773,21954547,21987299,22020091,22052839,22085621,22118399,22151167,22183883,22216673,22249463,22282199,22315003,22347769,22380521,22413289,22446079,22478803,22511609,22544351,22577143,22609919,22642687,22675403,22708223,22740961,22773743,22806521,22839263,22872053,22904807,22937591,22970351,23003131,23035843,23068667,23101439,23134201,23166943,23199731,23232499,23265247,23298043,23330773,23363581,23396339,23429117,23461877,23494651,23527409,23560189,23592937,23625703,23658493,23691257,23724031,23756791,23789561,23822317,23855101,23887849,23920607,23953387,23986159,24018937,24051683,24084479,24117217,24150001,24182773,24215537,24248299,24281071,24313853,24346607,24379391,24412151,24444881,24477667,24510463,24543229,24575977,24608747,24641479,24674269,24707071,24739807,24772603,24805373,24838127,24870863,24903667,24936427,24969193,25001981,25034731,25067501,25100287,25133051,25165813,25198583,25231351,25264123,25296893,25329659,25362431,25395179,25427957,25460731,25493483,25526269,25559033,25591799,25624567,25657339,25690097,25722877,25755619,25788397,25821179,25853939,25886719,25919483,25952243,25985023,26017759,26050547,26083273,26116081,26148853,26181619,26214379,26247149,26279899,26312681,26345471,26378201,26411003,26443757,26476543,26509283,26542067,26574797,26607611,26640379,26673149,26705909,26738687,26771449,26804203,26836981,26869753,26902523,26935267,26968033,27000817,27033593,27066359,27099131,27131903,27164617,27197413,27230201,27262931,27295739,27328507,27361277,27394019,27426809,27459581,27492347,27525109,27557879,27590653,27623353,27656149,27688951,27721721,27754481,27787213,27820021,27852791,27885563,27918323,27951103,27983863,28016633,28049407,28082161,28114943,28147711,28180459,28213219,28246003,28278781,28311541,28344319,28377077,28409833,28442551,28475383,28508153,28540921,28573673,28606463,28639231,28671989,28704749,28737529,28770293,28803059,28835819,28868603,28901311,28934137,28966909,28999667,29032441,29065171,29097977,29130727,29163481,29196263,29229047,29261807,29294581,29327357,29360087,29392889,29425637,29458411,29491193,29523961,29556719,29589499,29622269,29654983,29687783,29720519,29753341,29786093,29818871,29851597,29884411,29917171,29949943,29982677,30015481,30048251,30081019,30113737,30146531,30179327,30212093,30244861,30277627,30310391,30343129,30375929,30408701,30441457,30474239,30506963,30539749,30572491,30605303,30638077,30670847,30703559,30736379,30769139,30801917,30834659,30867439,30900193,30932987,30965749,30998509,31031267,31064063,31096817,31129597,31162361,31195117,31227899,31260653,31293439,31326181,31358933,31391729,31424479,31457269,31490023,31522747,31555571,31588351,31621097,31653871,31686653,31719409,31752191,31784941,31817719,31850491,31883239,31916011,31948783,31981567,32014331,32047097,32079857,32112607,32145403,32178169,32210939,32243707,32276467,32309243,32342003,32374781,32407549,32440319,32473073,32505829,32538619,32571373,32604137,32636921,32669671,32702443,32735203,32767997,32800741,32833531,32866303,32899037,32931817,32964559,32997359,33030121,33062903,33095677,33128423,33161201,33193981,33226741,33259517,33292283,33325027,33357811,33390569,33423319,33456113,33488891,33521647,33554393,67108859,100663291,134217689,167772107,201326557,234881011,268435399,301989881,335544301,369098707,402653171,436207613,469762043,503316469,536870909,570425299,603979769,637534199,671088637,704643067,738197503,771751927,805306357,838860791,872415211,905969653,939524087,973078511,1006632947,1040187377,1073741789,1107296251,1140850681,1174405103,1207959503,1241513981,1275068407,1308622837,1342177237,1375731701,1409286139,1442840569,1476394991,1509949421,1543503851,1577058271,1610612711,1644167159,1677721597,1711276019,1744830457,1778384887,1811939317,1845493753,1879048183,1912602623,1946157053,1979711483,2013265907,2046820351,2080374781,2113929203,2147483647,2181038059,2214592469,2248146919,2281701371,2315255783,2348810231,2382364661,2415919073,2449473503,2483027959,2516582371,2550136811,2583691247,2617245641,2650800109,2684354557,2717908939,2751463399,2785017847,2818572287,2852126659,2885681143,2919235567,2952790003,2986344409,3019898867,3053453309,3087007741,3120562169,3154116601,3187671029,3221225461,3254779901,3288334303,3321888767,3355443167,3388997627,3422552057,3456106487,3489660919,3523215359,3556769743,3590324161,3623878633,3657433081,3690987473,3724541939,3758096383,3791650781,3825205247,3858759631,3892314077,3925868537,3959422969,3992977403,4026531833,4060086229,4093640689,4127195129,4160749547,4194303961,4227858373,4261412863,4294967291,4328521699,4362076153,4395630587,4429184987,4462739429,4496293873,4529848307,4563402749,4596957179,4630511539,4664066023,4697620457,4731174907,4764729341,4798283773,4831838197,4865392627,4898947051,4932501503,4966055911,4999610321,5033164793,5066719213,5100273653,5133828083,5167382527,5200936913,5234491373,5268045817,5301600233,5335154687,5368709117,5402263513,5435817979,5469372383,5502926837,5536481267,5570035711,5603590127,5637144553,5670698977,5704253431,5737807871,5771362291,5804916701,5838471131,5872025569,5905580029,5939134463,5972688877,6006243319,6039797747,6073352189,6106906621,6140461051,6174015481,6207569897,6241124347,6274678771,6308233201,6341787637,6375342079,6408896477,6442450939,6476005357,6509559767,6543114211,6576668663,6610223089,6643777513,6677331967,6710886373,6744440803,6777995243,6811549673,6845104121,6878658497,6912212981,6945767393,6979321847,7012876279,7046430707,7079985139,7113539569,7147093969,7180648439,7214202829,7247757311,7281311707,7314866149,7348420549,7381974989,7415529469,7449083903,7482638329,7516192763,7549747199,7583301617,7616856043,7650410483,7683964927,7717519357,7751073767,7784628211,7818182653,7851737059,7885291433,7918845943,7952400383,7985954789,8019509237,8053063661,8086618103,8120172539,8153726957,8187281351,8220835829,8254390237,8287944661,8321499089,8355053549,8388607979,8422162421,8455716817,8489271289,8522825719,8556380117,8589934583,8623489001,8657043427,8690597879,8724152249,8757706733,8791261163,8824815577,8858370043,8891924473,8925478889,8959033327,8992587761,9026142161,9059696621,9093251053,9126805433,9160359931,9193914349,9227468759,9261023227,9294577651,9328132091,9361686487,9395240929,9428795351,9462349811,9495904247,9529458677,9563013029,9596567551,9630121961,9663676387,9697230847,9730785277,9764339659,9797894137,9831448567,9865002991,9898557437,9932111837,9965666303,9999220681,10032775133,10066329587,10099884023,10133438461,10166992889,10200547297,10234101751,10267656169,10301210617,10334765047,10368319483,10401873917,10435428343,10468982759,10502537203,10536091589,10569646063,10603200497,10636754941,10670309371,10703863777,10737418213,10770972671,10804527079,10838081531,10871635967,10905190367,10938744829,10972299259,11005853693,11039408119,11072962553,11106516991,11140071421,11173625821,11207180269,11240734709,11274289133,11307843577,11341397959,11374952443,11408506873,11442061271,11475615727,11509170157,11542724591,11576279009,11609833439,11643387893,11676942317,11710496761,11744051173,11777605613,11811160043,11844714473,11878268921,11911823359,11945377781,11978932219,12012486653,12046041071,12079595519,12113149949,12146704369,12180258809,12213813239,12247367651,12280922053,12314476543,12348030913,12381585347,12415139839,12448694267,12482248703,12515803129,12549357539,12582911983,12616466419,12650020837,12683575283,12717129707,12750684139,12784238581,12817792993,12851347441,12884901877,12918456293,12952010717,12985565179,13019119601,13052674021,13086228479,13119782887,13153337321,13186891763,13220446201,13254000637,13287555059,13321109453,13354663853,13388218357,13421772781,13455327227,13488881657,13522436047,13555990523,13589544929,13623099377,13656653783,13690208237,13723762667,13757317117,13790871551,13824425971,13857980399,13891534841,13925089261,13958643709,13992198119,14025752551,14059306997,14092861357,14126415869,14159970277,14193524731,14227079071,14260633589,14294188001,14327742437,14361296881,14394851327,14428405709,14461960127,14495514619,14529069041,14562623477,14596177909,14629732343,14663286749,14696841209,14730395567,14763950053,14797504507,14831058941,14864613373,14898167803,14931722189,14965276661,14998831079,15032385527,15065939963,15099494383,15133048829,15166603223,15200157653,15233712127,15267266557,15300820979,15334375409,15367929853,15401484277,15435038699,15468593149,15502147571,15535701967,15569256427,15602810831,15636365309,15669919687,15703474159,15737028539,15770583019,15804137423,15837691823,15871246327,15904800767,15938355131,15971909627,16005464029,16039018481,16072572917,16106127277,16139681759,16173236201,16206790627,16240345087,16273899487,16307453947,16341008347,16374562777,16408117237,16441671677,16475226109,16508780543,16542334973,16575889403,16609443827,16642998269,16676552677,16710107123,16743661553,16777215997,16810770421,16844324837,16877879287,16911433727,16944988141,16978542587,17012097019,17045651419,17079205879,17112760271,17146314739,17179869143, };
static uint64 primes_2[] = { 31,61,89,127,157,191,223,251,283,317,349,383,409,443,479,509,541,571,607,631,661,701,733,761,797,829,863,887,919,953,991,1021,1051,1087,1117,1151,1181,1213,1237,1279,1307,1327,1373,1399,1439,1471,1499,1531,1567,1597,1627,1663,1693,1723,1759,1789,1823,1847,1879,1913,1951,1979,2011,2039,2069,2111,2143,2161,2207,2239,2269,2297,2333,2357,2399,2423,2459,2477,2521,2557,2591,2621,2647,2687,2719,2749,2777,2803,2843,2879,2909,2939,2971,3001,3037,3067,3089,3121,3167,3191,3229,3259,3271,3323,3359,3391,3413,3449,3469,3517,3547,3583,3613,3643,3677,3709,3739,3769,3803,3833,3863,3889,3931,3967,3989,4027,4057,4093,4127,4159,4177,4219,4253,4283,4297,4349,4373,4409,4447,4463,4507,4523,4567,4603,4639,4663,4703,4733,4759,4799,4831,4861,4889,4919,4957,4987,5023,5051,5087,5119,5147,5179,5209,5237,5279,5309,5333,5351,5407,5437,5471,5503,5531,5563,5591,5623,5659,5693,5717,5749,5791,5821,5851,5881,5903,5939,5981,6011,6047,6079,6101,6143,6173,6203,6229,6271,6301,6329,6367,6397,6427,6451,6491,6521,6553,6581,6619,6653,6679,6719,6737,6781,6803,6841,6871,6911,6917,6971,7001,7039,7069,7103,7129,7159,7193,7229,7253,7283,7321,7351,7369,7417,7451,7487,7517,7549,7583,7607,7643,7673,7703,7741,7759,7793,7829,7867,7901,7933,7963,7993,8017,8059,8093,8123,8147,8191,8221,8243,8287,8317,8329,8377,8389,8447,8467,8501,8543,8573,8599,8629,8669,8699,8731,8761,8783,8831,8863,8893,8923,8951,8971,9013,9049,9067,9109,9151,9181,9209,9241,9277,9311,9343,9371,9403,9439,9467,9497,9533,9551,9587,9631,9661,9689,9721,9749,9791,9817,9851,9887,9907,9949,9973,10009,10039,10079,10111,10141,10169,10193,10223,10271,10303,10333,10357,10399,10429,10463,10487,10513,10559,10589,10613,10651,10687,10711,10739,10781,10799,10847,10867,10909,10939,10973,11003,11027,11071,11093,11131,11161,11197,11213,11261,11287,11321,11353,11383,11423,11447,11483,11519,11551,11579,11597,11633,11677,11701,11743,11743,11807,11839,11867,11903,11933,11959,11987,12011,12049,12073,12119,12157,12163,12211,12253,12281,12301,12347,12379,12413,12437,12479,12511,12541,12569,12601,12637,12671,12703,12721,12763,12799,12829,12853,12893,12923,12959,12983,13009,13049,13063,13109,13151,13183,13187,13241,13267,13309,13339,13367,13399,13421,13469,13499,13523,13567,13597,13627,13649,13693,13723,13759,13789,13807,13841,13883,13913,13933,13967,14011,14033,14071,14107,14143,14173,14207,14221,14251,14303,14327,14347,14389,14431,14461,14489,14519,14557,14591,14621,14653,14683,14717,14747,14783,14813,14843,14879,14897,14939,14969,14983,15031,15061,15101,15131,15161,15199,15227,15263,15289,15319,15359,15391,15413,15451,15473,15511,15551,15583,15607,15647,15679,15683,15739,15773,15803,15823,15859,15901,15923,15959,15991,16007,16063,16091,16127,16141,16189,16223,16253,16273,16319,16349,16381,16411,16447,16477,16493,16529,16573,16607,16633,16661,16703,16729,16763,16787,16831,16843,16889,16927,16943,16987,17011,17047,17053,17107,17123,17167,17207,17231,17239,17293,17333,17351,17393,17419,17467,17491,17509,17539,17597,17623,17657,17681,17707,17747,17789,17791,17839,17863,17909,17929,17977,17989,18043,18061,18089,18133,18149,18191,18229,18257,18289,18313,18353,18379,18413,18457,18481,18521,18541,18583,18593,18617,18671,18713,18743,18757,18797,18803,18859,18899,18917,18959,18979,19031,19051,19081,19087,19157,19181,19219,19249,19273,19309,19319,19387,19421,19441,19477,19501,19541,19577,19603,19603,19609,19699,19727,19759,19793,19813,19861,19889,19919,19961,19993,20023,20051,20071,20117,20147,20177,20201,20233,20269,20287,20341,20359,20407,20441,20477,20507,20533,20551,20593,20627,20641,20681,20719,20753,20773,20807,20849,20879,20903,20947,20981,21019,21023,21061,21101,21143,21169,21193,21227,21269,21277,21323,21341,21401,21419,21433,21499,21523,21559,21589,21613,21649,21673,21713,21751,21773,21817,21841,21871,21893,21937,21961,22003,22037,22073,22109,22129,22159,22189,22193,22259,22291,22303,22349,22391,22397,22447,22481,22501,22543,22571,22619,22643,22669,22709,22741,22777,22807,22811,22871,22901,22937,22963,22993,23029,23063,23087,23117,23159,23189,23209,23227,23291,23321,23339,23369,23399,23431,23459,23497,23539,23567,23603,23629,23671,23687,23741,23767,23789,23831,23857,23893,23917,23929,23981,24023,24049,24083,24113,24137,24179,24203,24247,24251,24281,24329,24373,24407,24439,24469,24499,24527,24551,24571,24623,24659,24691,24709,24763,24793,24809,24851,24877,24919,24943,24979,24989,25033,25073,25111,25127,25171,25183,25243,25253,25307,25339,25367,25373,25423,25469,25469,25471,25541,25583,25609,25643,25679,25703,25747,25763,25801,25847,25867,25913,25943,25969,25999,26029,26041,26107,26119,26161,26189,26227,26263,26293,26317,26347,26393,26423,26449,26479,26501,26539,26573,26591,26641,26683,26713,26731,26777,26801,26833,26863,26893,26921,26953,26987,27017,27061,27091,27109,27127,27191,27197,27253,27281,27283,27329,27361,27407,27437,27481,27487,27541,27581,27583,27631,27653,27697,27739,27767,27799,27823,27847,27893,27917,27961,27983,28027,28051,28081,28111,28123,28181,28211,28219,28279,28309,28349,28349,28409,28439,28463,28493,28537,28571,28603,28627,28663,28697,28723,28753,28789,28813,28843,28871,28921,28933,28961,29021,29027,29063,29077,29137,29173,29207,29231,29251,29303,29333,29347,29399,29429,29443,29483,29527,29537,29587,29611,29641,29671,29717,29753,29761,29803,29837,29879,29881,29927,29959,30011,30029,30059,30103,30137,30161,30197,30211,30269,30271,30319,30347,30389,30427,30431,30491,30509,30557,30559,30577,30643,30671,30707,30713,30773,30803,30839,30869,30893,30937,30949,30977,31033,31063,31081,31121,31153,31189,31223,31253,31271,31321,31337,31387,31393,31393,31477,31513,31543,31573,31601,31627,31663,31687,31729,31769,31793,31799,31849,31883,31891,31957,31981,32027,32059,32083,32117,32143,32189,32203,32237,32257,32303,32327,32377,32411,32441,32467,32503,32533,32569,32587,32621,32647,32687,32717,32719,65519,98297,131063,163811,196583,229351,262133,294893,327667,360421,393203,425959,458729,491501,524269,557033,589807,622571,655351,688097,720877,753647,786419,819173,851953,884699,917471,950251,982973,1015753,1048571,1081331,1114063,1146869,1179637,1212397,1245149,1277909,1310693,1343477,1376231,1408999,1441757,1474549,1507301,1540079,1572841,1605629,1638349,1671139,1703899,1736689,1769431,1802231,1834999,1867769,1900541,1933289,1966049,1998827,2031599,2064373,2097133,2129891,2162663,2195441,2228209,2260961,2293751,2326507,2359261,2392021,2424823,2457563,2490329,2523107,2555893,2588669,2621387,2654149,2686949,2719709,2752493,2785261,2818033,2850797,2883563,2916337,2949113,2981873,3014647,3047419,3080159,3112933,3145711,3178459,3211207,3244009,3276781,3309541,3342323,3375077,3407851,3440621,3473383,3506159,3538919,3571681,3604427,3637217,3670001,3702697,3735541,3768307,3801067,3833777,3866617,3899381,3932147,3964907,3997649,4030441,4063211,4095979,4128763,4161499,4194287,4227049,4259833,4292593,4325351,4358141,4390889,4423667,4456429,4489189,4521973,4554749,4587497,4620281,4653031,4685789,4718569,4751333,4784093,4816859,4849639,4882421,4915153,4947949,4980691,5013457,5046253,5078993,5111761,5144567,5177327,5210087,5242859,5275583,5308351,5341169,5373923,5406707,5439463,5472227,5505001,5537783,5570519,5603267,5636069,5668823,5701571,5734343,5767109,5799929,5832647,5865439,5898199,5930957,5963761,5996527,6029281,6062039,6094787,6127603,6160379,6193129,6225899,6258653,6291437,6324203,6356981,6389741,6422509,6455261,6488003,6520823,6553571,6586339,6619099,6651851,6684647,6717427,6750193,6782959,6815729,6848483,6881263,6914003,6946789,6979573,7012333,7045109,7077877,7110637,7143419,7176179,7208941,7241701,7274479,7307219,7339999,7372721,7405537,7438309,7471081,7503863,7536589,7569383,7602143,7634929,7667707,7700471,7733197,7765987,7798753,7831511,7864291,7897049,7929829,7962593,7995373,8028121,8060881,8093671,8126449,8159213,8191969,8224751,8257519,8290291,8323043,8355817,8388587,8421241,8454139,8486873,8519617,8552437,8585191,8617943,8650723,8683511,8716271,8749019,8781793,8814569,8847353,8880101,8912863,8945641,8978377,9011159,9043963,9076723,9109469,9142207,9175013,9207773,9240509,9273317,9306079,9338839,9371623,9404393,9437173,9469937,9502687,9535451,9568201,9600991,9633773,9666533,9699289,9732083,9764849,9797551,9830377,9863131,9895877,9928679,9961459,9994219,10026971,10059757,10092529,10125299,10158077,10190819,10223561,10256353,10289129,10321901,10354657,10387397,10420183,10452917,10485731,10518523,10551259,10584029,10616791,10649581,10682317,10715113,10747889,10780643,10813403,10846159,10878953,10911697,10944509,10977251,11010029,11042807,11075567,11108341,11141111,11173859,11206627,11239411,11272169,11304941,11337701,11370439,11403221,11436013,11468783,11501551,11534309,11567077,11599849,11632633,11665391,11698117,11730913,11763691,11796467,11829217,11862007,11894759,11927533,11960297,11993077,12025813,12058609,12091379,12124153,12156847,12189647,12222433,12255179,12287993,12320743,12353521,12386293,12419021,12451799,12484601,12517319,12550099,12582853,12615623,12648431,12681203,12713951,12746711,12779449,12812227,12844987,12877757,12910577,12943297,12976109,13008881,13041647,13074407,13107191,13139941,13172717,13205471,13238249,13271029,13303783,13336567,13369289,13402063,13434851,13467613,13500353,13533151,13565891,13598693,13631459,13664237,13697003,13729759,13762547,13795291,13828091,13860857,13893553,13926377,13959151,13991911,14024669,14057441,14090233,14122991,14155727,14188519,14221297,14253959,14286799,14319583,14352323,14385121,14417869,14450641,14483431,14516213,14548969,14581739,14614489,14647267,14680037,14712799,14745547,14778359,14811107,14843897,14876651,14909417,14942173,14974919,15007721,15040469,15073217,15106033,15138769,15171523,15204337,15237059,15269851,15302641,15335393,15368161,15400949,15433673,15466453,15499213,15531959,15564797,15597541,15630301,15663061,15695837,15728593,15761399,15794161,15826919,15859651,15892447,15925237,15958003,15990769,16023533,16056301,16089071,16121839,16154603,16187357,16220137,16252891,16285667,16318411,16351211,16383973,16416749,16449527,16482269,16515043,16547827,16580569,16613281,16646053,16678889,16711637,16744423,16777199,16809977,16842743,16875487,16908259,16941049,16973753,17006533,17039329,17072117,17104853,17137651,17170421,17203127,17235941,17268703,17301439,17334221,17367011,17399803,17432543,17465321,17498081,17530837,17563631,17596379,17629121,17661901,17694683,17727469,17760233,17793019,17825789,17858539,17891281,17924063,17956831,17989597,18022391,18055153,18087887,18120653,18153427,18186191,18218983,18251771,18284531,18317293,18350023,18382841,18415583,18448307,18481069,18513883,18546613,18579391,18612157,18644963,18677719,18710509,18743239,18776029,18808819,18841517,18874363,18907123,18939863,18972643,19005419,19038193,19070969,19103687,19136501,19169257,19202039,19234807,19267541,19300331,19333091,19365877,19398641,19431409,19464169,19496957,19529707,19562479,19595243,19628027,19660793,19693559,19726327,19759079,19791853,19824611,19857353,19890149,19922891,19955653,19988467,20021213,20054003,20086769,20119529,20152291,20185031,20217833,20250569,20283353,20316143,20348903,20381677,20414437,20447183,20479937,20512741,20545493,20578291,20611033,20643769,20676583,20709323,20742103,20774899,20807621,20840399,20873159,20905967,20938739,20971493,21004261,21037013,21069781,21102581,21135347,21168101,21200831,21233647,21266407,21299153,21331903,21364709,21397489,21430237,21463021,21495787,21528517,21561329,21594101,21626797,21659633,21692383,21725161,21757873,21790697,21823433,21856243,21889003,21921769,21954533,21987293,22020079,22052827,22085611,22118363,22151161,22183877,22216661,22249421,22282181,22314997,22347763,22380497,22413269,22446071,22478801,22511597,22544293,22577129,22609907,22642667,22675397,22708207,22740943,22773733,22806457,22839251,22872049,22904779,22937581,22970341,23003117,23035823,23068607,23101387,23134171,23166931,23199721,23232493,23265241,23298031,23330767,23363579,23396323,23429113,23461873,23494649,23527403,23560153,23592929,23625697,23658491,23691253,23724023,23756767,23789537,23822303,23855099,23887841,23920591,23953381,23986153,24018919,24051673,24084469,24117211,24149989,24182761,24215509,24248297,24281057,24313843,24346603,24379387,24412147,24444877,24477617,24510449,24543221,24575953,24608729,24641459,24674267,24707057,24739783,24772597,24805351,24838117,24870851,24903653,24936413,24969187,25001959,25034717,25067491,25100281,25133047,25165807,25198571,25231331,25264117,25296889,25329653,25362401,25395157,25427953,25460719,25493471,25526261,25559029,25591763,25624561,25657327,25690081,25722871,25755571,25788379,25821149,25853921,25886713,25919461,25952237,25985017,26017757,26050543,26083271,26116061,26148833,26181611,26214367,26247127,26279873,26312677,26345453,26378167,26410999,26443733,26476537,26509267,26542057,26574767,26607599,26640359,26673109,26705893,26738669,26771431,26804191,26836969,26869751,26902507,26935253,26968031,27000793,27033583,27066353,27099109,27131887,27164609,27197411,27230179,27262877,27295679,27328487,27361253,27394013,27426781,27459571,27492343,27525103,27557851,27590627,27623333,27656137,27688907,27721711,27754471,27787189,27820003,27852767,27885553,27918311,27951089,27983861,28016627,28049387,28082107,28114939,28147709,28180393,28213189,28245983,28278779,28311533,28344317,28377047,28409819,28442537,28475353,28508149,28540849,28573669,28606447,28639229,28671983,28704737,28737509,28770289,28803043,28835809,28868599,28901293,28934123,28966891,28999657,29032403,29065139,29097973,29130709,29163469,29196241,29229043,29261797,29294569,29327351,29360083,29392879,29425573,29458393,29491157,29523953,29556707,29589493,29622251,29654971,29687773,29720507,29753327,29786089,29818843,29851559,29884409,29917163,29949919,29982649,30015457,30048223,30081011,30113723,30146471,30179273,30212089,30244843,30277613,30310373,30343123,30375911,30408689,30441427,30474163,30506941,30539737,30572483,30605299,30638057,30670841,30703553,30736367,30769129,30801893,30834631,30867377,30900151,30932981,30965741,30998507,31031257,31064041,31096811,31129583,31162331,31195027,31227871,31260641,31293389,31326149,31358927,31391713,31424467,31457267,31489999,31522717,31555549,31588331,31621081,31653851,31686649,31719367,31752169,31784927,31817701,31850471,31883231,31916009,31948759,31981531,32014319,32047049,32079841,32112593,32145389,32178163,32210923,32243693,32276441,32309237,32341997,32374763,32407541,32440313,32473061,32505797,32538613,32571367,32604127,32636899,32669647,32702437,32735177,32767963,32800739,32833529,32866289,32899019,32931809,32964557,32997353,33030119,33062899,33095659,33128399,33161197,33193973,33226733,33259483,33292271,33325009,33357803,33390559,33423311,33456083,33488869,33521629,33554383,67108837,100663261,134217649,167772103,201326551,234880981,268435367,301989829,335544277,369098701,402653117,436207571,469762021,503316427,536870879,570425279,603979759,637534181,671088619,704643031,738197501,771751909,805306349,838860769,872415161,905969641,939524051,973078507,1006632941,1040187349,1073741783,1107296249,1140850661,1174405087,1207959469,1241513969,1275068401,1308622823,1342177229,1375731673,1409286103,1442840557,1476394961,1509949411,1543503827,1577058269,1610612699,1644167081,1677721571,1711275971,1744830433,1778384827,1811939299,1845493723,1879048169,1912602619,1946157047,1979711473,2013265901,2046820337,2080374773,2113929173,2147483629,2181038053,2214592463,2248146913,2281701349,2315255779,2348810227,2382364657,2415919069,2449473451,2483027947,2516582347,2550136807,2583691237,2617245613,2650800107,2684354539,2717908937,2751463369,2785017841,2818572269,2852126657,2885681119,2919235531,2952789991,2986344377,3019898857,3053453281,3087007723,3120562121,3154116583,3187671013,3221225453,3254779883,3288334289,3321888733,3355443163,3388997621,3422551973,3456106483,3489660899,3523215349,3556769737,3590324141,3623878619,3657433037,3690987457,3724541923,3758096371,3791650711,3825205243,3858759629,3892314073,3925868519,3959422967,3992977381,4026531829,4060086203,4093640651,4127195047,4160749543,4194303947,4227858347,4261412843,4294967279,4328521697,4362076127,4395630583,4429184971,4462739389,4496293853,4529848303,4563402703,4596957163,4630511533,4664065999,4697620429,4731174863,4764729323,4798283767,4831838159,4865392583,4898947013,4932501467,4966055873,4999610309,5033164783,5066719211,5100273641,5133828059,5167382491,5200936889,5234491349,5268045767,5301600173,5335154683,5368709113,5402263511,5435817929,5469372371,5502926797,5536481227,5570035651,5603590117,5637144521,5670698923,5704253417,5737807849,5771362243,5804916661,5838471127,5872025543,5905579937,5939134459,5972688871,6006243307,6039797737,6073352183,6106906577,6140461043,6174015479,6207569887,6241124317,6274678763,6308233109,6341787607,6375342041,6408896471,6442450933,6476005351,6509559757,6543114203,6576668629,6610223077,6643777457,6677331943,6710886367,6744440779,6777995233,6811549663,6845104069,6878658491,6912212969,6945767359,6979321837,7012876267,7046430697,7079985137,7113539557,7147093931,7180648421,7214202803,7247757299,7281311669,7314866101,7348420537,7381974967,7415529463,7449083857,7482638321,7516192757,7549747133,7583301581,7616855999,7650410461,7683964921,7717519349,7751073709,7784628193,7818182629,7851737057,7885291417,7918845917,7952400367,7985954773,8019509233,8053063651,8086618087,8120172499,8153726953,8187281341,8220835823,8254390219,8287944619,8321499083,8355053533,8388607963,8422162417,8455716809,8489271233,8522825681,8556380113,8589934567,8623488977,8657043403,8690597869,8724152237,8757706721,8791261081,8824815491,8858370007,8891924441,8925478867,8959033313,8992587749,9026142137,9059696539,9093251039,9126805417,9160359919,9193914343,9227468737,9261023203,9294577631,9328132087,9361686473,9395240903,9428795339,9462349789,9495904241,9529458643,9563013023,9596567521,9630121951,9663676369,9697230821,9730785271,9764339633,9797894089,9831448547,9865002919,9898557353,9932111809,9965666239,9999220663,10032775111,10066329503,10099883939,10133438429,10166992861,10200547289,10234101749,10267656151,10301210597,10334765009,10368319471,10401873887,10435428337,10468982737,10502537113,10536091571,10569646057,10603200467,10636754903,10670309357,10703863741,10737418193,10770972637,10804527077,10838081489,10871635933,10905190349,10938744827,10972299223,11005853657,11039408117,11072962543,11106516977,11140071401,11173625807,11207180227,11240734669,11274289123,11307843571,11341397887,11374952441,11408506867,11442061159,11475615721,11509170151,11542724551,11576278999,11609833421,11643387803,11676942293,11710496753,11744051153,11777605603,11811160033,11844714457,11878268903,11911823353,11945377753,11978932213,12012486581,12046041043,12079595509,12113149907,12146704331,12180258799,12213813221,12247367633,12280922041,12314476523,12348030911,12381585343,12415139827,12448694183,12482248699,12515803067,12549357503,12582911963,12616466389,12650020829,12683575279,12717129697,12750684137,12784238567,12817792973,12851347429,12884901871,12918456283,12952010683,12985565167,13019119583,13052673989,13086228469,13119782881,13153337317,13186891717,13220446199,13254000541,13287555053,13321109447,13354663843,13388218331,13421772769,13455327217,13488881629,13522436041,13555990517,13589544923,13623099349,13656653771,13690208221,13723762649,13757317111,13790871547,13824425969,13857980393,13891534831,13925089259,13958643697,13992198113,14025752441,14059306993,14092861339,14126415827,14159970257,14193524693,14227078979,14260633567,14294187991,14327742413,14361296869,14394851321,14428405703,14461960087,14495514601,14529069011,14562623461,14596177889,14629732331,14663286731,14696841197,14730395557,14763950039,14797504489,14831058929,14864613371,14898167783,14931722131,14965276657,14998831061,15032385481,15065939921,15099494369,15133048823,15166603219,15200157649,15233712119,15267266507,15300820967,15334375367,15367929817,15401484269,15435038657,15468593123,15502147553,15535701959,15569256413,15602810813,15636365257,15669919663,15703474153,15737028473,15770582999,15804137417,15837691819,15871246289,15904800761,15938355113,15971909567,16005463973,16039018459,16072572913,16106127259,16139681749,16173236197,16206790609,16240345067,16273899479,16307453917,16341008323,16374562751,16408117211,16441671671,16475226091,16508780531,16542334957,16575889381,16609443803,16642998193,16676552653,16710107009,16743661523,16777215991,16810770419,16844324813,16877879279,16911433703,16944988133,16978542533,17012096999,17045651401,17079205861,17112760193,17146314709,17179869107, };

uint64 HashMap::get_nextsize(uint64 size, uint64 *magic)
{
    for (uint i = 0; i < sizeof(primes_1) / sizeof(primes_1[0]); i++)
    {
        if (size <= primes_1[i])
        {
            if (magic)
                *magic = primes_2[i];
            return primes_1[i];
        }
    }

    return 0;
}

bool HashMap::init(uint64 capacity, std::function<void*(void*, uint32)> alloc, std::function<void(void*)> dealloc)
{
    assert(alloc != nullptr);
    assert(dealloc != nullptr);

    this->capacity_ = get_nextsize(capacity, &this->magic_);
    this->count_ = 0;
    if(this->capacity_ == 0)
    {
        orb::Error::set_error(1, "The specified capacity of elements is too large to support.");
        return false;
    }

    this->alloc_ = alloc;
    this->dealloc_ = dealloc;
    this->buckets_ = orb::address_align<Bucket>(this + 1, 32);
    memset(this->buckets_, 0, this->capacity_ * sizeof(Bucket));

    return true;
}

uint64 HashMap::hash_key(Key &key)
{
    uint64 hash = 0;

    switch(key.type)
    {
    case TYPE_LONG:
        hash = (uint64)key.iv2 * 131 + (uint64)key.iv1;
        break;
    case TYPE_STRING:
        for(int i=0; i<key.len; i++)
            hash = hash * 131 + key.s[i];
        break;
    default:
        assert(0);
    }

    return hash;
}

uint64 HashMap::find_bucket(Key &key, Bucket *bucket, bool *exists)
{
    uint16 index, h1, h2;
    uint64 hash, freebucket = BUCKET_TOMB;
    std::vector<char> ss;

    if(key.type == TYPE_STRING && key.len <= KEY_SK_STRING_MAX_LEN)
    {
        const char *s = orb::utf16to8(key.s, key.len, ss);
        if(!s)
            return BUCKET_TOMB;
    }

    hash = hash_key(key);
    h1 = hash % this->capacity_;
    for (uint64 i = 0; i < this->capacity_; i++)
    {
        if (i == 0)
            index = h1;
        else
        {
            h2 = this->magic_ - hash % this->magic_;
            index = (h1 + i * h2) % this->capacity_;
        }

        *(__m256i*)bucket = _mm256_load_si256((const __m256i*)&this->buckets_[index]);
        if(bucket->tag == BUCKET_UNUSED)
        {
            *exists = false;
            return freebucket == BUCKET_TOMB ? index : freebucket;
        }
        else if(bucket->tag == BUCKET_TOMB)
        {
            if(freebucket == BUCKET_TOMB)
                freebucket = index;
        }
        else if(key.type == TYPE_LONG && bucket->key_type == TYPE_LONG)
        {
            if(key.iv1 == bucket->key_iv1 && key.iv2 == bucket->key_iv2)
            {
                *exists = true;
                return index;
            }
        }
        else if(key.type == TYPE_STRING && (bucket->key_type == TYPE_STRING || bucket->key_type == TYPE_SK_STRING))
        {
            if(bucket->key_type == TYPE_STRING)
            {
                if(bucket->key_len == key.len
                        && memcmp(bucket->key_s, key.s, bucket->key_len * sizeof(uchar)) == 0)
                {
                    *exists = true;
                    return index;
                }
            }
            else //TYPE_SK_STRING
            {
                if(bucket->key_len == ss.size()
                        && memcmp(bucket->key_ss, key.ss, bucket->key_len) == 0)
                {
                    *exists = true;
                    return index;
                }
            }
        }
    }

    return BUCKET_TOMB;
}

bool HashMap::exists(Key &key)
{
    Bucket bucket;
    bool exists;
    uint64 index;

    index = find_bucket(key, &bucket, &exists);
    if(index == BUCKET_TOMB)
        return false;

	return exists;
}

bool HashMap::get(Key &key, Value &value)
{
    Bucket bucket;
    bool exists;
    uint64 index;

    index = find_bucket(key, &bucket, &exists);
    if(index == BUCKET_TOMB || !exists)
        return false;

    value.type = static_cast<Type>(bucket.value_type);
    switch(bucket.value_type)
    {
    case TYPE_LONG:
        value.iv = bucket.iv;
        break;
    case TYPE_DOUBLE:
        value.fv = bucket.fv;
        break;
    case TYPE_STRING:
        value.s = (const uchar*)(bucket.s + 1);
        value.len = bucket.s->len;
        break;
    case TYPE_BINARY:
        value.d = (const uint8*)(bucket.d + 1);
        value.len = bucket.d->len;
        break;
    }

	return true;
}

bool HashMap::put(Key &key, Value &value)
{
    Bucket bucket;
    bool exists;
    uint64 index;
    void *ptr_delay_free = nullptr;

    index = find_bucket(key, &bucket, &exists);
    if(index == BUCKET_TOMB)
        return false;

    if(!exists && this->count_ + 1 > (uint64)(this->capacity_ * HASHMAP_FACTOR))
    {
        orb::Error::set_error(1, "Hash table capacity reached threshold");
        return false;
    }

    //set new key if key not already exists
    if(!exists)
    {
        if(key.type == TYPE_LONG)
        {
            bucket.key_type = TYPE_LONG;
            bucket.key_len = 0;
            bucket.key_iv1 = key.iv1;
            bucket.key_iv2 = key.iv2;
        }
        else if(key.type == TYPE_STRING)
        {
            bucket.key_type = TYPE_STRING;

            if (key.len <= KEY_SK_STRING_MAX_LEN)
            {
                std::vector<char> ss;
                const char *s = orb::utf16to8(key.s, key.len, ss);
                if (!s)
                    return false;
                if(ss.size() <= KEY_SK_STRING_MAX_LEN)
                {
                    bucket.key_type = TYPE_SK_STRING;
                    bucket.key_len = ss.size();
                    memcpy(bucket.key_ss, s, ss.size() + 1);
                }
            }

            if(bucket.key_type == TYPE_STRING)
            {
                bucket.key_len = key.len;
                bucket.key_s = (uchar*)this->alloc_(nullptr, (key.len + 1) * sizeof(uchar));
                if(bucket.key_s == nullptr)
                {
                    orb::Error::set_error(1, "There is not enough memory to store the value");
                    return false;
                }
                memcpy(bucket.key_s, key.s, key.len * sizeof(uchar));
                bucket.key_s[key.len] = 0;
            }
        }
        else
        {
            assert(0);
        }
    }
    else
    {
        //remember delay free reference value first
        switch(bucket.value_type)
        {
        case TYPE_STRING:
            ptr_delay_free = bucket.s;
            break;
        case TYPE_BINARY:
            ptr_delay_free = bucket.d;
            break;
        }
    }

    //set new value
    switch(value.type)
    {
    case TYPE_LONG:
        bucket.iv = value.iv;
        break;
    case TYPE_DOUBLE:
        bucket.fv = value.fv;
        break;
    case TYPE_STRING:
        {
            bucket.s = (StringData*) this->alloc_(nullptr,
                    sizeof(StringData) + (value.len + 1) * sizeof(uchar));
            if (bucket.s == nullptr)
            {
                orb::Error::set_error(1,
                        "There is not enough memory to store the value");
                return false;
            }
            bucket.s->len = value.len;
            uchar *s = (uchar*) (bucket.s + 1);
            memcpy(s, value.s, value.len * sizeof(uchar));
            s[value.len] = 0;
        }
        break;
    case TYPE_BINARY:
        {
            bucket.d = (BinaryData*) this->alloc_(nullptr,
                    sizeof(BinaryData) + value.len);
            if (bucket.d == nullptr)
            {
                orb::Error::set_error(1,
                        "There is not enough memory to store the value");
                return false;
            }
            bucket.d->len = value.len;
            uint8 *d = (uint8*) (bucket.d + 1);
            memcpy(d, value.d, value.len);
        }
        break;
    }

    //store
    _mm256_store_si256((__m256i*)&this->buckets_[index], *(__m256i*)&bucket);

    //delay free reference value
    if(ptr_delay_free)
        this->dealloc_(ptr_delay_free);

    if(!exists)
        this->count_++;

    return true;
}

void* HashMap::end() const
{
	return &this->buckets_[this->capacity_];
}

